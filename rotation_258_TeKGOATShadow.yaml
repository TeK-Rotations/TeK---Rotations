version: 1
author: Tek
class: Shadow
name: Shadow priest - TeK
spec: 258
version: 3
entry: main

morphs:
  voidform: void_volley
  mind_blast: void_blast
  devouring_plague: shadow_word_madness

config:
  # Defensive Configuration
  dispersion_enable:
    label: "Dispersion"
    type: checkbox
    default: true
  dispersion_hp:
    label: "Dispersion HP"
    type: slider
    min: 10
    max: 40
    default: 20
  desperate_prayer_hp:
    label: "Prayer HP"
    type: slider
    min: 30
    max: 90
    default: 50
  healthstone_enable:
    label: "Healthstone"
    type: checkbox
    default: true
  healthstone_hp:
    label: "Stone HP"
    type: slider
    min: 20
    max: 60
    default: 30
  pw_shield_enable:
    label: "Shield"
    type: checkbox
    default: true
  pw_shield_hp:
    label: "Shield HP"
    type: slider
    min: 40
    max: 95
    default: 60
  pw_shield_allies:
    label: "Smart Ally Shield"
    type: checkbox
    default: true
  pw_shield_allies_hp:
    label: "Ally Shield HP"
    type: slider
    min: 30
    max: 80
    default: 50
  flash_heal_enable:
    label: "Flash Heal"
    type: checkbox
    default: true
  flash_heal_hp:
    label: "FH Self HP"
    type: slider
    min: 15
    max: 50
    default: 25
  flash_heal_targets:
    label: "Flash Heal Targets"
    type: dropdown
    options:
      - label: "Self Only"
        value: 1
      - label: "Self & Allies"
        value: 2
    default: 2
  flash_heal_allies_hp:
    label: "FH Allies HP"
    type: slider
    min: 15
    max: 50
    default: 25
  vampiric_embrace_enable:
    label: "Vamp Embrace"
    type: checkbox
    default: true
  vampiric_embrace_self_hp:
    label: "VE Self HP"
    type: slider
    min: 30
    max: 80
    default: 50
  vampiric_embrace_allies:
    label: "VE Allies Count"
    type: slider
    min: 1
    max: 5
    default: 2
  vampiric_embrace_allies_hp:
    label: "VE Allies HP"
    type: slider
    min: 40
    max: 80
    default: 60
  
  # TeK: Dispel & Support Configuration
  purify_disease_enable:
    label: "Purify Disease"
    type: checkbox
    default: true
  purify_disease_targets:
    label: "Purify Targets"
    type: dropdown
    options:
      - label: "Self Only"
        value: 1
      - label: "Self & Allies"
        value: 2
    default: 2
  mass_dispel_enable:
    label: "Mass Dispel"
    type: checkbox
    default: false
  mass_dispel_members:
    label: "Mass Dispel Members"
    type: slider
    min: 2
    max: 5
    default: 3
  desperate_prayer_tank:
    label: "Prayer on Tank"
    type: checkbox
    default: false
  desperate_prayer_tank_hp:
    label: "Tank Prayer HP"
    type: slider
    min: 20
    max: 60
    default: 35
  
  angelic_feather_enable:
    label: "Auto Feather Mode"
    type: checkbox
    default: true

  angelic_feather_delay:
    label: "Feather Delay"
    type: slider
    min: 0
    max: 3
    default: 1
  apex_tentacle_slam:
    label: "Apex 4/4"
    type: checkbox
    default: false
  
  # Time to Die (Cooldown Protection)
  ttd_voidform:
    label: "Voidform HP %"
    type: slider
    min: 0
    max: 100
    default: 30
  ttd_power_infusion:
    label: "Power Infusion HP %"
    type: slider
    min: 0
    max: 100
    default: 30
  ttd_void_torrent:
    label: "Void Torrent HP %"
    type: slider
    min: 0
    max: 100
    default: 30
  ttd_trinkets:
    label: "Trinkets HP %"
    type: slider
    min: 0
    max: 100
    default: 20
  ttd_tentacle_charges:
    label: "Tent Slam Charges HP %"
    type: slider
    min: 0
    max: 100
    default: 30

variables:
  enemies_need_vt: active_enemies-nameplates.debuff.vampiric_touch.count
  
  # Angelic Feather automation
  should_cast_feather: "!buff.angelic_feather.up&player.moving&player.moving.time>=config.angelic_feather_delay&cooldown.angelic_feather.charges>0&!mounted&((config.angelic_feather_enable=1&player.combat)|(config.angelic_feather_enable=2&!player.combat)|(config.angelic_feather_enable=3))"
  
  # Blood Elf Arcane Torrent
  has_arcane_torrent: player.race=10
  target_has_enrage: target.buff.spell_1221133.up|target.buff.spell_326450.up|target.buff.spell_463061.up|target.buff.spell_355057.up|target.buff.spell_356133.up|target.buff.spell_1244446.up|target.buff.spell_353706.up|target.buff.spell_1242074.up|target.buff.spell_451112.up|target.buff.spell_424419.up
  target_has_purge: target.buff.spell_1231608.up|target.buff.spell_1223000.up|target.buff.spell_471733.up|target.buff.spell_1240214.up|target.buff.spell_427346.up|target.buff.spell_444728.up|target.buff.spell_427342.up|target.buff.spell_349933.up|target.buff.spell_355980.up|target.buff.spell_347775.up|target.buff.spell_450756.up
  target_purgeable: var.target_has_enrage|var.target_has_purge

lists:
  sanity_checks:
    - return,if=player.dead
    - return,if=state.blocked_inputs

  spell_queue:
    - queue_spell

  racials:
    # Racial cooldowns - sync with Voidform and Power Infusion
    #- fireblood,if=buff.voidform.up&buff.power_infusion.up|target.time_to_die<=8
    #- berserking,if=buff.voidform.up&buff.power_infusion.up|target.time_to_die<=12
    #- blood_fury,if=buff.voidform.up&buff.power_infusion.up|target.time_to_die<=15
    #- ancestral_call,if=buff.voidform.up&buff.power_infusion.up|target.time_to_die<=15

  trinkets:
    # Burst window synchronization - align with major CDs (only if target will live long enough)
    - trinket_1,if=buff.voidform.up&trinket_1.usable&target.health.pct>config.ttd_trinkets
    - trinket_2,if=buff.voidform.up&trinket_2.usable&target.health.pct>config.ttd_trinkets
    # Fallback for Dark Ascension builds
    - trinket_1,if=buff.dark_ascension.up&trinket_1.usable&target.health.pct>config.ttd_trinkets
    - trinket_2,if=buff.dark_ascension.up&trinket_2.usable&target.health.pct>config.ttd_trinkets
    
  archon:
    # TeK Archon Rotation - Optimized for M+ with defensive layers
    # Priority Interrupts - Cancel Mind Flay for critical abilities
    
    # Tentacle Slam for initial dot application (better than VT on fresh targets)
    - tentacle_slam,interrupt=true,casting_check=mind_flay,if=target.enemy&(!dot.vampiric_touch.up|!dot.shadow_word_pain.up)
    
    # Multi-target dot application via Tentacle Slam
    - tentacle_slam,interrupt=true,casting_check=mind_flay,if=target.enemy&active_enemies>1&nameplates.debuff.vampiric_touch.count<active_enemies
    
    # Fallback to manual VT only if Tentacle Slam is on CD
    - vampiric_touch,interrupt=true,casting_check=mind_flay,if=target.enemy&dot.vampiric_touch.remains<=6.3&!action.tentacle_slam.ready
    - shadow_word_pain,interrupt=true,casting_check=mind_flay,if=target.enemy&dot.shadow_word_pain.refreshable&talent.invoked_nightmare&!action.tentacle_slam.ready
    
    # Burst window sequencing (save for healthy targets)
    - voidform,interrupt=true,casting_check=mind_flay,if=target.health.pct>config.ttd_voidform
    - trinket_1,interrupt=true,casting_check=mind_flay,if=buff.voidform.up&trinket_1.usable
    - trinket_2,interrupt=true,casting_check=mind_flay,if=buff.voidform.up&trinket_2.usable
    - power_infusion,interrupt=true,casting_check=mind_flay,range_check=none,if=target.health.pct>config.ttd_power_infusion
    - shadow_word_madness,interrupt=true,casting_check=mind_flay,if=buff.voidform.up&insanity>=50
    - shadow_word_madness,interrupt=true,casting_check=mind_flay,if=!buff.shadow_word_madness.up&insanity>=50
    - shadow_word_madness,interrupt=true,casting_check=mind_flay,if=insanity>=95
    - void_volley,interrupt=true,casting_check=mind_flay,if=buff.voidform.up
    - mind_blast,interrupt=true,casting_check=mind_flay
    - shadow_word_death,interrupt=true,casting_check=mind_flay
    - shadow_word_madness,interrupt=true,casting_check=mind_flay
    
    # Standard rotation priority
    
    # Tentacle Slam for initial dot application (better than VT on fresh targets)
    - tentacle_slam,if=target.enemy&(!dot.vampiric_touch.up|!dot.shadow_word_pain.up)
    
    # AoE dot spreading when enemies lack debuffs
    - tentacle_slam,if=target.enemy&active_enemies>1&nameplates.debuff.vampiric_touch.count<active_enemies
    
    # Fallback to manual VT only if Tentacle Slam is on CD
    - vampiric_touch,if=target.enemy&dot.vampiric_touch.remains<=6.3&!action.tentacle_slam.ready
    - shadow_word_pain,if=target.enemy&dot.shadow_word_pain.refreshable&talent.invoked_nightmare&!action.tentacle_slam.ready
    
    - voidform,if=target.health.pct>config.ttd_voidform
    - trinket_1,if=buff.voidform.up&trinket_1.usable
    - trinket_2,if=buff.voidform.up&trinket_2.usable
    - power_infusion,range_check=none,if=target.health.pct>config.ttd_power_infusion
    - shadow_word_madness,if=buff.voidform.up&insanity>=50
    - shadow_word_madness,if=!buff.shadow_word_madness.up&insanity>=50
    - shadow_word_madness,if=insanity>=95
    - void_volley,if=buff.voidform.up
    - mind_blast
    - shadow_word_death
    
    # Charge management filler (save charges for next pack if target is low)
    - tentacle_slam,if=target.enemy&target.health.pct>config.ttd_tentacle_charges
    
    - shadow_word_madness
    - mind_flay

  voidweaver:
    # TeK Voidweaver Rotation - Entropic Rift optimization
    # Priority Interrupts - Cancel Mind Flay for critical abilities
    
    # Tentacle Slam for initial dot application (better than VT on fresh targets)
    - tentacle_slam,interrupt=true,casting_check=mind_flay,if=target.enemy&(!dot.vampiric_touch.up|!dot.shadow_word_pain.up)
    
    # Charge dump when 3+ targets need VT
    - tentacle_slam,interrupt=true,casting_check=mind_flay,if=target.enemy&cooldown.tentacle_slam.charges>=1.9&var.enemies_need_vt>2
    
    # Fallback to manual VT only if Tentacle Slam is on CD
    - vampiric_touch,interrupt=true,casting_check=mind_flay,if=target.enemy&dot.vampiric_touch.remains<=6.3&!action.tentacle_slam.ready
    - shadow_word_pain,interrupt=true,casting_check=mind_flay,if=target.enemy&dot.shadow_word_pain.refreshable&talent.invoked_nightmare&!action.tentacle_slam.ready
    
    # Burst window sequencing (save for healthy targets)
    - voidform,interrupt=true,casting_check=mind_flay,if=target.health.pct>config.ttd_voidform
    - trinket_1,interrupt=true,casting_check=mind_flay,if=buff.voidform.up&trinket_1.usable
    - trinket_2,interrupt=true,casting_check=mind_flay,if=buff.voidform.up&trinket_2.usable
    - power_infusion,interrupt=true,casting_check=mind_flay,range_check=none,if=target.health.pct>config.ttd_power_infusion
    - void_torrent,interrupt=true,casting_check=mind_flay,if=target.health.pct>config.ttd_void_torrent
    - mind_blast,interrupt=true,casting_check=mind_flay,if=buff.entropic_rift.up
    - shadow_word_madness,interrupt=true,casting_check=mind_flay,if=buff.entropic_rift.up&insanity>=50
    - shadow_word_madness,interrupt=true,casting_check=mind_flay,if=!buff.shadow_word_madness.up&insanity>=50
    - shadow_word_madness,interrupt=true,casting_check=mind_flay,if=insanity>=95
    - void_volley,interrupt=true,casting_check=mind_flay,if=buff.voidform.up
    - mind_blast,interrupt=true,casting_check=mind_flay
    - shadow_word_death,interrupt=true,casting_check=mind_flay
    - shadow_word_madness,interrupt=true,casting_check=mind_flay
    
    # Standard rotation priority
    
    # Tentacle Slam for initial dot application (better than VT on fresh targets)
    - tentacle_slam,if=target.enemy&(!dot.vampiric_touch.up|!dot.shadow_word_pain.up)
    
    # Multi-target or charge cap management (save charges if target is low HP)
    - tentacle_slam,if=target.enemy&((active_enemies>1&nameplates.debuff.vampiric_touch.count<active_enemies)|(cooldown.tentacle_slam.charges>=1.9&target.health.pct>config.ttd_tentacle_charges))
    
    # Fallback to manual VT only if Tentacle Slam is on CD
    - vampiric_touch,if=target.enemy&dot.vampiric_touch.remains<=6.3&!action.tentacle_slam.ready
    - shadow_word_pain,if=target.enemy&dot.shadow_word_pain.refreshable&talent.invoked_nightmare&!action.tentacle_slam.ready
    
    - voidform,if=target.health.pct>config.ttd_voidform
    - trinket_1,if=buff.voidform.up&trinket_1.usable
    - trinket_2,if=buff.voidform.up&trinket_2.usable
    - power_infusion,range_check=none,if=target.health.pct>config.ttd_power_infusion
    - shadow_word_madness,if=buff.voidform.up&!buff.shadow_word_madness.up&insanity>=30
    - void_torrent,if=buff.voidform.up&target.health.pct>config.ttd_void_torrent
    - mind_blast,if=buff.entropic_rift.up
    - shadow_word_madness,if=buff.entropic_rift.up&insanity>=40
    - shadow_word_madness,if=!buff.shadow_word_madness.up&insanity>=30
    - shadow_word_madness,if=insanity>=95
    - void_volley,if=buff.voidform.up
    - mind_blast
    - shadow_word_death
    
    # Charge management filler (save charges for next pack if target is low)
    - tentacle_slam,if=target.enemy&target.health.pct>config.ttd_tentacle_charges
    
    - shadow_word_madness
    - mind_flay

  precombat:
    - shadowform,range_check=none,if=!buff.shadowform.up
    - arcane_torrent,if=var.has_arcane_torrent&target.enemy&var.target_purgeable
    - vampiric_touch

  out_of_combat:
    # Future: Add out-of-combat healing here if needed

  main:
    # Rotation state check - exit if rotation disabled or mounted
    - return,if=!state.rotation|mounted
    
    # Buff maintenance (always check, regardless of combat state)
    - power_word_fortitude,if=!buff.power_word_fortitude.up|group.count(cycle.buff.power_word_fortitude.down&cycle.range>0&cycle.range<=40)>0
    
    # Out of combat actions (healing, etc)
    - call_action_list,name=out_of_combat,if=!player.combat
    
    # Movement speed boost automation (TeK) - independent of combat state
    - angelic_feather.player,range_check=none,if=var.should_cast_feather

    - call_action_list,name=spell_queue
    - call_action_list,name=sanity_checks
    - call_action_list,name=auto_target

    # TeK: Emergency defensives (consolidated for performance)
    - dispersion,if=config.dispersion_enable&player.health.pct<=config.dispersion_hp
    - desperate_prayer,if=(player.health.pct<=config.desperate_prayer_hp)|(player.health.pct<=50&debuff.duration>0)|(player.health.pct<=40&cooldown.dispersion.remains>30)
    
    # TeK: Tank Desperate Prayer (adapted from Alegr0n's Disc logic)
    - desperate_prayer.tank,if=config.desperate_prayer_tank&group.tank.health.pct<=config.desperate_prayer_tank_hp
    
    - healthstone,if=config.healthstone_enable&item.healthstone.count>0&((player.health.pct<=config.healthstone_hp&cooldown.desperate_prayer.remains>5)|player.health.pct<=25)
    
    # TeK: Vampiric Embrace - self emergency OR allies need healing (adapted from Alegr0n)
    - vampiric_embrace,if=config.vampiric_embrace_enable&!buff.dispersion.up&((player.health.pct<=config.vampiric_embrace_self_hp)|(group.count(cycle.health.pct<config.vampiric_embrace_allies_hp)>=config.vampiric_embrace_allies))
    
    # TeK: Purify Disease (adapted from Alegr0n's Disc logic)
    - purify_disease,if=config.purify_disease_enable&player.dispelable.purify_disease
    - purify_disease,target=lowest,if=config.purify_disease_enable&config.purify_disease_targets=2&group.lowest.dispelable.purify_disease
    - purify_disease,cycle=members,if=config.purify_disease_enable&config.purify_disease_targets=2&cycle.dispelable.purify_disease
    
    # TeK: Mass Dispel (adapted from Alegr0n's Disc logic)
    - mass_dispel,if=config.mass_dispel_enable&group.count(cycle.has_magic_debuff)>=config.mass_dispel_members
    
    - power_word_shield,if=config.pw_shield_enable&player.health.pct<=config.pw_shield_hp
    
    # TeK: Smart Ally Shield (adapted from Alegr0n's Disc logic)
    - power_word_shield,target=lowest,if=config.pw_shield_enable&config.pw_shield_allies&group.lowest.health.pct<=config.pw_shield_allies_hp&group.lowest.buff.remains(power_word_shield)=0
    - power_word_shield,cycle=members,if=config.pw_shield_enable&config.pw_shield_allies&cycle.health.pct<=config.pw_shield_allies_hp&cycle.buff.power_word_shield.down
    
    - fade,if=player.threat>90&target.target!=player
    
    # TeK: Emergency Flash Heal (adapted from Alegr0n's Disc logic - combat only)
    - flash_heal,if=config.flash_heal_enable&player.health.pct<config.flash_heal_hp&!player.moving
    - flash_heal,target=lowest,if=config.flash_heal_enable&config.flash_heal_targets=2&group.lowest.health.pct<config.flash_heal_allies_hp&!player.moving
    - flash_heal,cycle=members,if=config.flash_heal_enable&config.flash_heal_targets=2&cycle.health.pct<config.flash_heal_allies_hp&!player.moving

    # TeK: Offensive dispels - Arcane Torrent for enrages and shields (inspired by Alegr0n)
    - arcane_torrent,if=var.has_arcane_torrent&target.enemy&var.target_purgeable&target.range<=8

    - shadowform,range_check=none,if=!buff.shadowform.up

    # TeK: Movement optimization
    - power_word_shield,if=player.moving&talent.body_and_soul&buff.angelic_feather.remains<=0.2&cooldown.angelic_feather.charges==0&buff.power_word_shield.down

    # Moving DPS rotation
    - mind_flay_insanity,interrupt=true,casting_check=all,if=player.moving&buff.mind_flay_insanity.up
    - shadow_word_madness,interrupt=true,casting_check=all,if=player.moving&insanity>=95
    - tentacle_slam,interrupt=true,casting_check=all,if=target.enemy&player.moving&((active_enemies>1&nameplates.debuff.vampiric_touch.count<active_enemies)|(cooldown.tentacle_slam.charges>=1.9&target.health.pct>config.ttd_tentacle_charges))
    - shadow_word_death,interrupt=true,casting_check=all,if=player.moving&target.health.pct<20
    - shadow_word_pain,interrupt=true,casting_check=all,if=player.moving&talent.invoked_nightmare

    # Movement hard lock
    - return,if=player.moving&!action.mind_flay_insanity.ready&!action.tentacle_slam.ready&!action.shadow_word_death.ready&!action.shadow_word_pain.ready&(cooldown.angelic_feather.charges>0|buff.angelic_feather.remains>0.2|(talent.body_and_soul&cooldown.angelic_feather.charges==0&cooldown.angelic_feather.remains>0))

    # Interrupts
    - silence,if=config.interrupt_target&(config.interrupt_all&target.casting.interruptible|interrupts.target.ready)&target.casting.elapsed>=0.2&(target.casting.remains<1|target.channeling)
    - silence.mouseover,if=config.interrupt_mouseover&(config.interrupt_all&mouseover.casting.interruptible|interrupts.mouseover.ready)&mouseover.casting.elapsed>=0.2&(mouseover.casting.remains<1|mouseover.channeling)
    - silence.focus,if=config.interrupt_focus&(config.interrupt_all&focus.casting.interruptible|interrupts.focus.ready)&focus.casting.elapsed>=0.2&(focus.casting.remains<1|focus.channeling)

    # Combat Check
    - return,if=!player.combat&!((config.auto_combat.has(1)&target.quest_mob&target.enemy)|(config.auto_combat.has(2)&target.combat&target.enemy)|(config.auto_combat.has(3)&player.auto_attacking&target.enemy))
    - return,if=!player.combat&config.auto_combat.has(0)

    # Target Check
    - return,if=!target.valid&!((config.auto_combat.has(1)&target.quest_mob&target.enemy&!target.dead)|(config.auto_combat.has(2)&target.combat&target.enemy&!target.dead)|(config.auto_combat.has(3)&player.auto_attacking&target.enemy&!target.dead))
    - return,if=!target.valid&config.auto_combat.has(0)

    # Out-of-combat opener
    - call_action_list,name=precombat,if=!player.combat

    # Rotation dispatch
    - call_action_list,name=racials
    - call_action_list,name=archon,if=talent.halo
    - call_action_list,name=voidweaver,if=talent.void_torrent
